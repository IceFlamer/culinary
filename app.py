import streamlit as st
import pandas as pd
import numpy as np
import random
from PIL import Image
import os

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
st.set_page_config(
    page_title="–ì–∞—á–∞-—Å–∏–º—É–ª—è—Ç–æ—Ä –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤",
    page_icon="üçÄ",
    layout="wide"
)

# –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
st.title("üçÄ –ì–∞—á–∞-—Å–∏–º—É–ª—è—Ç–æ—Ä: –í—ã–ø–∞–¥–µ–Ω–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤")
st.markdown("---")

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö
@st.cache_data
def load_data(file):
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç Excel-—Ñ–∞–π–ª –∏ –ø–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ—Ç –≤–µ—Å–∞ –¥–ª—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞."""
    df = pd.read_excel(file, engine='openpyxl')
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö
    required_columns = [0, 1, 2, 3]  # –ò–Ω–¥–µ–∫—Å—ã —Å—Ç–æ–ª–±—Ü–æ–≤ A, B, C, D
    if df.shape[1] < 4:
        st.error("‚ùå –í —Ñ–∞–π–ª–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∫–∞–∫ –º–∏–Ω–∏–º—É–º 4 —Å—Ç–æ–ª–±—Ü–∞: ‚Ññ, –ù–∞–∑–≤–∞–Ω–∏–µ, –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –†–µ–¥–∫–æ—Å—Ç—å")
        return None
    
    # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º —Å—Ç–æ–ª–±—Ü—ã –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
    df.columns = ['id', 'name', 'image', 'rarity'] + list(df.columns[4:])
    
    # –°–æ–∑–¥–∞–µ–º –≤–µ—Å–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–¥–∫–æ—Å—Ç–∏ (—á–µ–º –≤—ã—à–µ —Ä–µ–¥–∫–æ—Å—Ç—å, —Ç–µ–º —á–∞—â–µ –≤—ã–ø–∞–¥–∞–µ—Ç)
    # –†–µ–¥–∫–æ—Å—Ç—å 3 -> –≤–µ—Å 3, —Ä–µ–¥–∫–æ—Å—Ç—å 2 -> –≤–µ—Å 2, —Ä–µ–¥–∫–æ—Å—Ç—å 1 -> –≤–µ—Å 1
    df['weight'] = df['rarity']
    
    # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –≤–µ—Å–∞ (–¥–µ–ª–∞–µ–º –∏—Ö –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—è–º–∏)
    total_weight = df['weight'].sum()
    df['probability'] = df['weight'] / total_weight
    
    return df

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤—ã–ø–∞–≤—à–∏—Ö –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤
def generate_drops(df, num_drops):
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã —Å —É—á–µ—Ç–æ–º —Ä–µ–¥–∫–æ—Å—Ç–∏."""
    if df is None:
        return []
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–Ω—ã–π –≤—ã–±–æ—Ä —Å —É—á–µ—Ç–æ–º –≤–µ—Å–æ–≤
    # –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å random.choices —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º weights
    indices = random.choices(
        range(len(df)), 
        weights=df['weight'].values, 
        k=num_drops
    )
    
    results = []
    for idx in indices:
        ingredient = df.iloc[idx]
        results.append({
            'id': ingredient['id'],
            'name': ingredient['name'],
            'image': ingredient['image'],
            'rarity': ingredient['rarity']
        })
    
    return results

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞
def display_ingredient_card(ingredient, images_dir):
    """–°–æ–∑–¥–∞–µ—Ç –∫–∞—Ä—Ç–æ—á–∫—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞."""
    # –¶–≤–µ—Ç —Ä–∞–º–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–¥–∫–æ—Å—Ç–∏
    rarity_colors = {
        1: "#FFD700",  # –ó–æ–ª–æ—Ç–æ–π –¥–ª—è —Å–∞–º–æ–π —Ä–µ–¥–∫–æ–π
        2: "#C0C0C0",  # –°–µ—Ä–µ–±—Ä—è–Ω—ã–π
        3: "#CD7F32"   # –ë—Ä–æ–Ω–∑–æ–≤—ã–π –¥–ª—è —Å–∞–º–æ–π —á–∞—Å—Ç–æ–π
    }
    
    # –ü–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é
    image_path = os.path.join(images_dir, ingredient['image'])
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
    if os.path.exists(image_path):
        try:
            img = Image.open(image_path)
            # –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            img.thumbnail((200, 200))
        except Exception as e:
            # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É
            img = Image.new('RGB', (200, 200), color='lightgray')
    else:
        # –ó–∞–≥–ª—É—à–∫–∞ –µ—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω
        img = Image.new('RGB', (200, 200), color='lightgray')
    
    # –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É
    with st.container():
        # –†–∞–º–∫–∞ —Å —Ü–≤–µ—Ç–æ–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–¥–∫–æ—Å—Ç–∏
        st.markdown(f"""
        <div style="
            border: 3px solid {rarity_colors[ingredient['rarity']]};
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            margin: 5px;
            height: 320px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        ">
        """, unsafe_allow_html=True)
        
        # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        st.image(img, width=150)
        
        # –ù–∞–∑–≤–∞–Ω–∏–µ –∏ —Ä–µ–¥–∫–æ—Å—Ç—å
        st.markdown(f"**{ingredient['name']}**")
        
        # –ó–≤–µ–∑–¥–æ—á–∫–∏ –¥–ª—è —Ä–µ–¥–∫–æ—Å—Ç–∏
        stars = "‚òÖ" * (4 - ingredient['rarity'])  # –ò–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º: 1 —Ä–µ–¥–∫–æ—Å—Ç—å = 3 –∑–≤–µ–∑–¥—ã
        st.markdown(f"<span style='color: {rarity_colors[ingredient['rarity']]};'>{stars}</span>", 
                   unsafe_allow_html=True)
        
        # ID –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        st.markdown(f"<small>ID: {ingredient['id']}</small>", unsafe_allow_html=True)
        
        st.markdown("</div>", unsafe_allow_html=True)

# –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
def main():
    # –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
    with st.sidebar:
        st.header("‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏")
        
        # –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
        uploaded_file = st.file_uploader(
            "üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç–µ Excel-—Ñ–∞–π–ª —Å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞–º–∏", 
            type=['xlsx', 'xls']
        )
        
        # –í–≤–æ–¥ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤
        num_drops = st.number_input(
            "üé≤ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏",
            min_value=1,
            max_value=100,
            value=12,
            step=1
        )
        
        # –ö–Ω–æ–ø–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        generate_button = st.button(
            "üé∞ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å!",
            type="primary",
            use_container_width=True
        )
        
        # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—è—Ö
        st.markdown("---")
        st.markdown("### üìä –®–∞–Ω—Å—ã –≤—ã–ø–∞–¥–µ–Ω–∏—è")
        st.markdown("""
        - ü•â **–†–µ–¥–∫–æ—Å—Ç—å 3**: –ß–∞—Å—Ç–æ–µ –≤—ã–ø–∞–¥–µ–Ω–∏–µ (–Ω–∞–∏–±–æ–ª—å—à–∏–π –≤–µ—Å)
        - ü•à **–†–µ–¥–∫–æ—Å—Ç—å 2**: –°—Ä–µ–¥–Ω–µ–µ –≤—ã–ø–∞–¥–µ–Ω–∏–µ
        - ü•á **–†–µ–¥–∫–æ—Å—Ç—å 1**: –†–µ–¥–∫–æ–µ –≤—ã–ø–∞–¥–µ–Ω–∏–µ (–Ω–∞–∏–º–µ–Ω—å—à–∏–π –≤–µ—Å)
        """)
        
        # –ü—É—Ç—å –∫ –ø–∞–ø–∫–µ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
        st.markdown("---")
        st.markdown("### üìÅ –ü–∞–ø–∫–∞ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏")
        st.info("–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ –ø–∞–ø–∫–µ 'images' –µ—Å—Ç—å –≤—Å–µ —Ñ–∞–π–ª—ã, —É–∫–∞–∑–∞–Ω–Ω—ã–µ –≤ Excel.")
    
    # –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å
    if uploaded_file is not None:
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        df = load_data(uploaded_file)
        
        if df is not None:
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            st.subheader("üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤")
            
            col1, col2, col3 = st.columns(3)
            with col1:
                st.metric("–í—Å–µ–≥–æ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤", len(df))
            with col2:
                rare_count = len(df[df['rarity'] == 1])
                st.metric("–†–µ–¥–∫–∏—Ö (‚≠ê)", rare_count)
            with col3:
                common_count = len(df[df['rarity'] == 3])
                st.metric("–ß–∞—Å—Ç—ã—Ö (‚≠ê‚≠ê‚≠ê)", common_count)
            
            # –¢–∞–±–ª–∏—Ü–∞ —Å –¥–∞–Ω–Ω—ã–º–∏
            with st.expander("üìã –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã"):
                st.dataframe(df[['id', 'name', 'rarity', 'probability']].style.format({
                    'probability': '{:.2%}'
                }))
            
            # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏
            if generate_button:
                st.markdown("---")
                st.subheader(f"üéÅ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã: {num_drops} –≤—ã–ø–∞–≤—à–∏—Ö –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤")
                
                # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤—ã–ø–∞–≤—à–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã
                drops = generate_drops(df, num_drops)
                
                # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤—ã–ø–∞–¥–µ–Ω–∏–π
                rarity_counts = {1: 0, 2: 0, 3: 0}
                for drop in drops:
                    rarity_counts[drop['rarity']] += 1
                
                st_col1, st_col2, st_col3 = st.columns(3)
                with st_col1:
                    st.metric("–†–µ–¥–∫–∏—Ö –≤—ã–ø–∞–ª–æ", rarity_counts[1])
                with st_col2:
                    st.metric("–°—Ä–µ–¥–Ω–∏—Ö –≤—ã–ø–∞–ª–æ", rarity_counts[2])
                with st_col3:
                    st.metric("–ß–∞—Å—Ç—ã—Ö –≤—ã–ø–∞–ª–æ", rarity_counts[3])
                
                # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ —Å–µ—Ç–∫–µ
                st.markdown("### üñºÔ∏è –í—ã–ø–∞–≤—à–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã")
                
                # –°–æ–∑–¥–∞–µ–º —Å–µ—Ç–∫—É –∫–∞—Ä—Ç–æ—á–µ–∫
                cols_per_row = 6  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ä—Ç–æ—á–µ–∫ –≤ —Ä—è–¥—É
                rows = (len(drops) + cols_per_row - 1) // cols_per_row
                
                for row in range(rows):
                    cols = st.columns(cols_per_row)
                    for col_idx in range(cols_per_row):
                        drop_idx = row * cols_per_row + col_idx
                        if drop_idx < len(drops):
                            with cols[col_idx]:
                                display_ingredient_card(drops[drop_idx], "images")
                
                # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å —Ç–µ–º–∏ –∂–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
                st.markdown("---")
                if st.button("üîÑ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –µ—â–µ —Ä–∞–∑", type="secondary"):
                    st.rerun()
        else:
            st.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞.")
    else:
        # –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –µ—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
        st.info("üëà –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ Excel-—Ñ–∞–π–ª —á–µ—Ä–µ–∑ –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å.")
        
        # –ü—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ñ–∞–π–ª–∞
        with st.expander("üìã –ö–∞–∫ –¥–æ–ª–∂–µ–Ω –≤—ã–≥–ª—è–¥–µ—Ç—å Excel-—Ñ–∞–π–ª?"):
            st.markdown("""
            | ‚Ññ | –ù–∞–∑–≤–∞–Ω–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞ | –§–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è | –†–µ–¥–∫–æ—Å—Ç—å |
            |---|----------------------|------------------|----------|
            | 1 | –Ø–±–ª–æ–∫–æ               | apple.png        | 3        |
            | 2 | –ë–∞–Ω–∞–Ω                | banana.png       | 3        |
            | 3 | –î—É—Ä–∏–∞–Ω               | durian.png       | 1        |
            """)
            st.markdown("""
            **–í–∞–∂–Ω–æ:**
            1. –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏
            2. –ü–µ—Ä–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü (A) - –Ω—É–º–µ—Ä–∞—Ü–∏—è
            3. –í—Ç–æ—Ä–æ–π —Å—Ç–æ–ª–±–µ—Ü (B) - –Ω–∞–∑–≤–∞–Ω–∏—è
            4. –¢—Ä–µ—Ç–∏–π —Å—Ç–æ–ª–±–µ—Ü (C) - –∏–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (–¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –ø–∞–ø–∫–µ `images`)
            5. –ß–µ—Ç–≤–µ—Ä—Ç—ã–π —Å—Ç–æ–ª–±–µ—Ü (D) - —Ä–µ–¥–∫–æ—Å—Ç—å (1-3, –≥–¥–µ 3 - —Å–∞–º–∞—è —á–∞—Å—Ç–∞—è)
            """)

if __name__ == "__main__":
    main()